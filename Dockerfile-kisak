# This Dockerfile creates a self-contained, verifiable base image with upgraded Mesa drivers.
# Its purpose is to prove that the Kisak PPA provides native OpenGL 4.6 support.
FROM ubuntu:24.04

# Set non-interactive frontend to avoid prompts during build
ARG DEBIAN_FRONTEND=noninteractive

# Install prerequisites, add the Kisak PPA, and install the latest Mesa drivers and Xvfb.
RUN apt-get update && \
    apt-get install -y --no-install-recommends software-properties-common && \
    add-apt-repository ppa:kisak/kisak-mesa && \
    apt-get update && \
    apt-get install -y --no-install-recommends mesa-utils xvfb && \
    rm -rf /var/lib/apt/lists/*

# Copy in an entrypoint script that robustly starts the virtual display before running a command.
RUN cat <<'EOF' > /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/entrypoint.sh
#!/bin/bash
set -e

# Set the display variable for the virtual framebuffer
export DISPLAY=:99

# Start Xvfb in the background on the specified display
Xvfb $DISPLAY -screen 0 1280x1024x24 &

# ROBUST WAIT: Actively wait for the X server's socket to appear before proceeding.
XVFB_SOCKET="/tmp/.X11-unix/X99"
retries=0
while [ ! -S "$XVFB_SOCKET" ] && [ "$retries" -lt 30 ]; do
  retries=$((retries+1))
  sleep 0.1
done
if [ ! -S "$XVFB_SOCKET" ]; then
  echo "Xvfb failed to start after 3 seconds." >&2
  exit 1
fi

# Execute the main command passed to the container (e.g., glxinfo -B)
exec "$@"
EOF

# Set the new script as the main executable
ENTRYPOINT ["entrypoint.sh"]

# Set the default command to run for verification.
CMD ["glxinfo", "-B"]
